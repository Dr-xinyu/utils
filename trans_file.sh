#!/bin/bash

# ==========================================
# 🚀 智能文件/目录传输工具 (带全局进度条)
# ==========================================

# 默认不删除源文件（即默认行为是“复制”）
DELETE_SOURCE=false
SOURCE=""
DEST=""

# ==========================================
# 📖 帮助文档函数
# ==========================================
show_help() {
    echo "================================================================"
    echo "🚀 智能文件/目录传输工具"
    echo "================================================================"
    echo "用法: $0 [选项] <源路径> <目标路径>"
    echo ""
    echo "选项:"
    echo "  -h, --help    显示此帮助信息并退出"
    echo "  -m, --move    移动模式：传输完全成功后，安全删除源文件"
    echo ""
    echo "工作模式:"
    echo "  【默认】复制: 文件传输完成后，源文件将被保留。"
    echo "  【加 -m】移动: 文件传输完成后，源文件将被自动彻底清理。"
    echo ""
    echo "示例:"
    echo "  1. 仅复制并显示进度 (保留原文件):"
    echo "     $0 ./my_large_folder /mnt/external_hdd/"
    echo "  2. 移动并显示进度 (传完即删，释放空间):"
    echo "     $0 -m ./my_video.mp4 /mnt/usb_drive/"
    echo "================================================================"
    exit 0
}

# ==========================================
# ⚙️ 解析命令行参数
# ==========================================
# 循环读取所有参数
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) 
            show_help 
            ;;
        -m|--move) 
            DELETE_SOURCE=true
            shift # 移除该选项，继续处理后面的路径参数
            ;;
        -*) 
            echo "❌ 错误: 未知选项 '$1'。"
            echo "💡 提示: 输入 '$0 -h' 查看使用说明。"
            exit 1 
            ;;
        *)
            # 将未带 - 的参数依次赋值给源路径和目标路径
            if [ -z "$SOURCE" ]; then
                SOURCE="$1"
            elif [ -z "$DEST" ]; then
                DEST="$1"
            else
                echo "❌ 错误: 提供的参数过多！"
                show_help
            fi
            shift
            ;;
    esac
done

# ==========================================
# 🔍 基础校验
# ==========================================
if [ -z "$SOURCE" ] || [ -z "$DEST" ]; then
    echo "❌ 错误: 缺少源路径或目标路径。"
    echo "💡 提示: 输入 '$0 -h' 查看完整使用说明。"
    exit 1
fi

if [ ! -e "$SOURCE" ]; then
    echo "❌ 错误: 源路径 '$SOURCE' 不存在！"
    exit 1
fi

# ==========================================
# 📦 开始传输逻辑
# ==========================================
if [ "$DELETE_SOURCE" = true ]; then
    echo "📦 [模式: 移动] 准备传输..."
else
    echo "📦 [模式: 复制] 准备传输..."
fi

echo "从: $SOURCE"
echo "到: $DEST"
echo "---------------------------------------------------"

# 使用 rsync 进行传输
# -a: 归档模式 (保留权限/时间戳)
# -h: 人类可读格式 (MB/GB)
# --info=progress2: 显示全局总进度条
# --partial: 支持断点续传
rsync -ah --info=progress2 --partial "$SOURCE" "$DEST"
RSYNC_EXIT_CODE=$?

# ==========================================
# ✅ 结果处理与安全清理
# ==========================================
if [ $RSYNC_EXIT_CODE -eq 0 ]; then
    echo -e "\n---------------------------------------------------"
    echo "✅ 传输完美结束！"
    
    # 只有在明确传入了 -m 参数，且传输成功时，才执行删除
    if [ "$DELETE_SOURCE" = true ]; then
        echo "🗑️ 正在清理源文件释放空间..."
        
        # 极简的安全锁：防止误删系统根目录
        if [ "$SOURCE" != "/" ] && [ "$SOURCE" != "/*" ]; then
            rm -rf "$SOURCE"
            if [ $? -eq 0 ]; then
                echo "✨ 移动彻底完成！源文件 '$SOURCE' 已成功清理。"
            else
                echo "⚠️ 源文件清理失败，请检查权限后手动删除 '$SOURCE'。"
            fi
        else
            echo "❌ 危险操作拦截：系统拒绝删除根目录级别的路径！"
        fi
    else
        echo "✨ 复制完成！源数据已安全保留。"
    fi
else
    # 传输失败或被用户中途 Ctrl+C 中断
    echo -e "\n---------------------------------------------------"
    echo "❌ 传输过程中出现错误或被中断！"
    if [ "$DELETE_SOURCE" = true ]; then
        echo "🛡️ 安全机制已触发：由于传输未 100% 成功，您的源文件已被保护，未发生任何数据丢失。"
    fi
    echo "💡 提示: 您可以随时重新运行此命令，它会自动从刚才断开的地方继续传输。"
    exit 1
fi